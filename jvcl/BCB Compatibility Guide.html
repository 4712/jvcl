<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <title>BCB Compatibility Guide</title>
  <link href="default.css" type="text/css" rel="STYLESHEET">
</head>
<body>
<h2>BCB Compatibility Guide</h2>
<p> </p>
<hr>
<p>This document describes the do's and don'ts of component writing
when you want your Delphi component to work with C++Builder. Many of
these issues were discovered while creating the JVCL packages for BCB6
(Enterprise US, update 2). As such there maybe other problems when
using these packages with BCB version 5. If you know of such issues or
even any other issues that might help us and other Delphi developers,
please contact the JVCL team through the newsgroups on talkto.net:<br>
<a href="news://forums.talkto.net/jedi.vcl">news://forums.talkto.net/jedi.vcl</a></p>
<p>&nbsp;</p>
<h3>Making your component work with BCB</h3>
<ul>
  <li><b>Do not use structures like TPoint and TRect as published
property     types.</b> Instead, if you need this functionality, define
and implement a     TPersistent class that provides the same
functionality.</li>
  <li><b>Do not use HDC as a published property type.</b> The reason for
this     error is still not found but in the meantime, use LongWord
instead.</li>
  <li><b>Do not declare class methods as dynamic.</b> Use virtual
instead.</li>
  <li><b>Do not declare class methods as abstract.</b> Use virtual
instead and     provide an empty implementation</li>
  <li><b>Do not use WEAKPACKAGEUNIT if you can avoid it</b>. This will
in some     cases cause a linker error, especially if the unit
contains constants,     resourcestrings and/or global variables.<br>
  </li>
</ul>
<p>&nbsp;</p>
<h3>Encountered errors and possible solutions when compiling a package
for BCB</h3>
When creating and/or updating packages with BCB, please keep in mind
that the IDE has a tendancy to put static paths in different locations.
This will prevent the packages from working on a machine different from
your own. This is why we recommend to use the IDE to do add or remove
files. You must also remove all required package as BCB will add a lot
of unecessary dependencies. For instance, it adds designintf.bpi in the
runtime packages. Then save the packages, close it and reopen it with a
text editor. You will see that a bpk file is just a XML file with
different nodes for different options. The cleaning process involves:<br>
<ul>
  <li>Removing all libraries from the SPARELIBS and LIBRARIES nodes.
Yes all.</li>
  <li>Removing all fixed path (C:\prog\bcb6 for instance) in every
places you see them. If package refuses to compile after that, you must
change your environment for it to work. There is no way we will force
users to put the JVCL in a particular path. Have a look at the
CJCL60.bpl error below for a solution. You may also want to use the
$(BCB) constant to refer to the location where BCB is installed.<br>
  </li>
  <li>Fixing all the wrong relative paths in the FILES nodes in the
FILELIST node. Usually, BCB will add ..\..\design or ..\..\run in front
of the required packages such as rtl.bpi, vcl.bpi and the JVCL ones.
These packages must be specified with no path information.<br>
  </li>
</ul>
Once you have cleaned the package, you can reopen it with BCB and
compile it. At first there is a great chance that it will complain
about missing object files (*.obj) at the linking stage. These are
solved by adding one package after the other in the requires list of
the package you are building. The usual order is:<br>
rtl.bpi, vcl.bpi, vclx.bpi. Database related packages may also require
dbrtl.bpi and vcldb.bpi<br>
If this is the case, use BCB to update your package, save it, close it
and verify it is still clean (it should, except maybe for SPARELIBS).
Once cleaned again, try to compile it. If it compiles and links, DO NOT
save it. It is fine the way it is, you don't want to have to clean it
again.<br>
On some occasions, BCB may come up with a dialog saying that your
package needs to require other packages in order to be compatible with
installed packages. You must accept these changes. BCB will
automatically recompile and relink your package. You then must save the
changes, reclean your package and retry to compile it.<br>
For design packages, you must try to install it, with all the packages
it depends on installed. For instance if your package depends on
JvCoreC6R.bpi, you must install yours with JvCoreC6D installed.<br>
If all went fine, your package is ready to use. Of course, you may
encounter some problems with pas files and the one we know of are
listed below.<br>
<br>
<h5>Null not defined</h5>
<p>You must add 'uses Variant' in the implementation section of the
incriminated pas file even if it was already in the interface section. <br>
Doing so would break Delphi compilation, so you must enclose it with
conditional compilation directives, {$IFDEF BCB6}uses Variant;{$ENDIF}<br>
&nbsp;</p>
<h5>Cannot find FiltEdit.dcu</h5>
<p>Add '-LUdclstd' to the PFLAGS node, and add dclstd.bpi to the
requires node. This should only be needed for designtime packages. If
you have this error with a runtime package, please notify us.<br>
<br>
</p>
<h5>Cannot find DesignIntf.dcu</h5>
<p>Add '-LUDesignIde' to the PFLAGS node, and add DesignIde.bpi to the
requires node. This should only be needed for designtime packages. If
you have this error with a runtime package, please notify us.<br>
&nbsp;</p>
<h5>Incompatible types: Set of char and String</h5>
<p>Some files in the JVCL were imported from libraries that had partial
support for BCB prior to version 5. As these versions did not support
sets, they were replaced by other constructs, most often strings. As
JVCL doesn't support anything below BCB5, all conditional compilation
directives defining Delphi sets as string must be removed to only
leave Delphi style sets definitions and as such remove this error.<br>
&nbsp;</p>
<h5>[Linker Error] Fatal: Access violation. Link Terminated.</h5>
<p>See "Do not use WEAKPACKAGEUNIT" above. These errors should have
been all removed from the JVCL following the discovery of a useless
WEAKPACKAGEUNIT directive in the file JclResources.pas from the
JCL.&nbsp; Their team has been informed and the file has been updated
but is not in the release version 2. If you install the JVCL without
updating the JCL, you will encounter heaps of these errors and there is
nothing to do about it but change the previously mentioned file.<br>
Before discovering this error, we found that changing the order of the
bpi files in the FILELIST node sometimes solved this crash. It is not
clear what is the best order, but you may want to try shuffling around
the order of CJCL60.bpi, JvCoreC6R.bpi and JvCoreC6D.bpi<br>
</p>
<p>This problem may arise from other files and because it actually is
the result of the linker crashing, it is very hard to track down.
Borland has been told about this problem, we are yet to receive any
answer from them.<br>
<br>
</p>
<h5>Cannot find CJCL60.bpl</h5>
<p>You must add CJCL60.bpi to the requires list of your package. The
directory to both CJCL60.bpi and CJCL60.bpl MUST be in the PATH
environment variable. If you don't have these files, you need to
compile the JCL first, with the BCB6 specific package. This package was
not in the version 2 release, you may obtain it from us or the JCL team
upon request on the newsgroup mentionned earlier in this document.<br>
&nbsp;</p>
<h5>Incompatible types</h5>
<p>Usually an error that has to do with record constructs being used to
perform automatic casting. This a language feature to avoid as it is
not supported by BCB.</p>
<p><br>
</p>
<h3>Encountered errors and possible solutions when compiling an
application using a JVCL component</h3>
These errors generally occur in a JVCL related hpp file. The hpp files
are generated from the interface section of the pas files which
requires that your components follow simple rules so that the generated
hpp file is a valid file. Some people have suggested that we should put
the hpp files in the distribution packages so that we can modify them
in order to repair them after they have been generated. This is not
possible because those modified files would be overwritten when the
users recompile the JVCL on their computers. And not requiring the
users to recompile would mean a precompiled distribution package at
least 80M big !<br>
So we are asking every developer in the JVCL team to follow the above
mentionned guidelines. However, from times to times, somebody may
encounter an error when using one of the JVCL components. The below
list contains the know errors and their solutions.<br>
<br>
<h5>Constructor already defined</h5>
<p>This problems comes from the fact that in C++, constructors are
named after the class name and there is no way to change that. So to
avoid confusion, avoid calling your constructors anything else than
Create. If you need additionnal parameters, use the overload directive
and adapt your code to take this into account. The disctinction between
the different constructors is made upon the order and the types of
their parameters. <br>
</p>
<p>But in the end, this may not be enough as Borland's VCL already
contains a number of constructors. As a result, the types you chose to
use for your own constructor may conflict with an existing constructor.
In such a case, you should follow Borland's guidelines from their help
files: Add a dummy parameter at the end, giving it a default value.
Usually, an Integer parameter is enough, like this:<br>
</p>
<div style="margin-left: 40px;">constructor Create(param1 : string;
param2 : Integer; dummyForBCB : Integer = 0);<br>
</div>
<p>From the C++ code, to be sure to call the correct constructor, you
must give a value for this dummy parameter even if it won't be used.</p>
<br>
<h5>E2303 Type name expected (on a __property line)</h5>
<p>This is because of bad casing on an inherited property. The usual
example is having a property named PopUpMenu where it should be
PopupMenu. BCB is case sensitive so you must respect casing in your
pas files, at least in the interface section.<br>
&nbsp;</p>
<h5>Declaration terminated incorrectly</h5>
<p>This generally happens on a constant declaration and is because the
pas files declares a value for a constant that already exists in the
header files bundled with BCB. You must tell the hpp generator not to
include this constant by adding a $EXTERNALSYM compilation directive in
the pas file, just after your pascal constant. For instance, you must
do this for S_OK</p>
<p>const S_OK : Integer = 0;<br>
{$EXTERNALSYM S_OK}<br>
&nbsp;<br>
</p>
<h5>Cannot initialize constant</h5>
<p>(or something similar, usually provokes 3 errors on the same line,
the second being the interesting one). This is because the parameter
name you chose for your function is a constant under BCB. The only
solution is to change the name of the incriminated parameter. This was
found with a parameter called SwitchChars in the GetCmdLineArg function
in JvJCLUtils.pas<br>
&nbsp;</p>
<h5>Ambiguity between SOMETYPE and SomeDomain::SOMETYPE</h5>
<p>This is because the type SOMETYPE is a global type (in windows.h,
generally) and is also defined in the SomeDomain file. To lift this
ambiguity, you must add a line at the beginning of the pas file that
does that: "{$HPPEMIT '#define SOMETYPE SomeDomain::SOMETYPE'}"</p>
<p>However, if this error is generated in an hpp file not from the JVCL
(filename not starting with Jv), such as Controls.hpp, you can't change
this file, you must reorder the units in your uses clause so that the
conflict goes away. For instance, in the case of Controls.hpp, the
solution was to put Controls before Windows in the uses clause.<br>
</p>
</body>
</html>
